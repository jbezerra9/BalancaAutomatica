unit uPrinc;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.StrUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Imaging.jpeg, Vcl.ExtCtrls,
  ACBrBase, ACBrBAL, Vcl.StdCtrls, Data.DB, Data.FMTBcd, Data.SqlExpr;

type
  TfPrinc = class(TForm)
    pnlTitulo: TPanel;
    Image1: TImage;
    pnlPeso: TPanel;
    FACBrBAL: TACBrBAL;
    mMensagem: TMemo;
    lbBBifood: TLabel;
    sqlcon: TSQLQuery;
    Label1: TLabel;
    Label2: TLabel;
    vrProd: TLabel;
    vrPeso: TLabel;
    procedure FormDestroy(Sender: TObject);
    procedure FACBrBALLePeso(Peso: Double; Resposta: AnsiString);
    procedure FormShow(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormResize(Sender: TObject);
  private
    { Private declarations }
    vrvenda : double;
    function lerBalanca(Peso : Double) : boolean;
  public
    { Public declarations }
    peso1 : double;
  end;

var
  fPrinc: TfPrinc;
  codUsuario: Integer;
  nomUsuario, sUserFunc, codCaixa, datasenha: String;
  sAcessoUsuario: String;
  sAcessoSenha : String;
  sCodProd     : String;

implementation

{$R *.dfm}

uses uFuncoes, uModulo, Utransacao, uMensagem, upesqcad;

function TfPrinc.lerBalanca(Peso : Double) : boolean;
begin
    if peso1 = peso then
       exit
    else
       peso1 := peso;

    if peso < strToFloat('0,020') then
      exit;

    mMensagem.Lines.Clear;
    mMensagem.Color    := clYellow;
    mMensagem.Lines.Add(' ');
    mMensagem.Lines.Add('Lendo balança...');
    mMensagem.Lines.Add(' ');

    sleep(3000);

    if peso1 <> peso then
    begin
        mMensagem.Lines.Clear;
        mMensagem.Lines.Add(' ');
        mMensagem.Lines.Add('Erro na leitura. ');
        mMensagem.Lines.Add('Retire o prato e coloque na balança');
        mMensagem.Color    := clRed;

        vrPeso.Caption      := '';
        vrProd.Caption      := '';
        exit;
    end;

    mMensagem.Lines.Clear;
    mMensagem.Color    := clLime;
    mMensagem.Lines.Add(' ');
    mMensagem.Lines.Add('Balança pronta.');
    mMensagem.Lines.Add('coloque o seu prato!');

    vrPeso.Caption      := Format('%.3f kg', [Peso]);
    vrProd.Caption      := FormatCurr('R$ #,##0.00', vrvenda * peso);
end;

procedure TfPrinc.FACBrBALLePeso(Peso: Double; Resposta: AnsiString);
begin
    if peso = strToFloat('0,000') then
    begin
        mMensagem.Lines.Clear;
        mMensagem.Lines.Add(' ');
        mMensagem.Lines.Add('Balança pronta.');
        mMensagem.Lines.Add('Coloque o seu prato!');
        mMensagem.Color    := clLime;

        vrPeso.Caption      := '';
        vrProd.Caption      := '';

        exit;
    end;

    lerBalanca(Peso);
end;

procedure TfPrinc.FormCreate(Sender: TObject);
begin
    FAcBrBAL.Ativar;
end;

procedure TfPrinc.FormDestroy(Sender: TObject);
begin
   // Desconecta da balança e libera o objeto
    FAcBrBAL.Desativar;
    FAcBrBAL.Free;
end;

procedure TfPrinc.FormResize(Sender: TObject);
begin
    pnlTitulo.Width := Fprinc.Width;
end;

procedure TfPrinc.FormShow(Sender: TObject);
var sql : string;
begin
    sCodProd := dm.sCodProd;

    sqlcon.close;
    sqlcon.SQL.Text := ' select pvendaa from tbprod where codigo = ' + quotedStr(scodprod) ;
    sqlcon.Open;

    if sqlcon.IsEmpty then
    begin
        Application.Messagebox('Produto invalido!', 'Atençao', mb_iconexclamation);
        close;
    end;

    vrvenda := sqlcon.FieldByName('pvendaa').AsFloat;

    mMensagem.Lines.Clear;
    mMensagem.Lines.Add(' ');
    mMensagem.Lines.Add('Balança pronta.');
    mMensagem.Lines.Add('Coloque o seu prato!');
    mMensagem.Color    := clLime;

    pnlPeso.Caption    := '';
    vrProd.Caption     := '';
end;

end.
