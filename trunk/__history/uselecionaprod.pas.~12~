unit uselecionaprod;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.StrUtils ,System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Data.FMTBcd, ACBrDeviceSerial,
  Data.DB, Data.SqlExpr, Datasnap.DBClient, Vcl.Buttons, ACBrBase, ACBrBAL, ACBrDevice;

type
  TfSelecionaProd = class(TForm)
    pnlMeio: TPanel;
    sqlcon: TSQLQuery;
    sqlaux: TSQLQuery;
    pnlProdutos: TPanel;
    lbSelecione: TLabel;
    btAnterior: TButton;
    btProx: TButton;
    pnlConfig: TPanel;
    gbBalanca: TGroupBox;
    lbQtdBalanca: TLabel;
    rgUsaBalanca: TRadioGroup;
    gbConfigBalanca: TGroupBox;
    lbBalanca: TLabel;
    lbModelo: TLabel;
    lbPortaSerial: TLabel;
    lbBaudRate: TLabel;
    lbDataBits: TLabel;
    lbParity: TLabel;
    lbHandshaking: TLabel;
    lbStopBits: TLabel;
    lbTimeOut: TLabel;
    edTimeOut3: TEdit;
    edTimeOut2: TEdit;
    cbStopBits3: TComboBox;
    cbParity3: TComboBox;
    cbHandShaking3: TComboBox;
    cbDataBits3: TComboBox;
    cbBaudRate3: TComboBox;
    cbPortaSerial3: TComboBox;
    cbModelo3: TComboBox;
    cbHandShaking2: TComboBox;
    cbStopBits2: TComboBox;
    cbParity2: TComboBox;
    cbDataBits2: TComboBox;
    cbBaudRate2: TComboBox;
    cbPortaSerial2: TComboBox;
    cbModelo2: TComboBox;
    cbBalanca: TComboBox;
    Panel2: TPanel;
    cbModelo1: TComboBox;
    cbPortaSerial1: TComboBox;
    cbBaudRate1: TComboBox;
    cbDataBits1: TComboBox;
    cbHandShaking1: TComboBox;
    cbParity1: TComboBox;
    cbStopBits1: TComboBox;
    edTimeOut1: TEdit;
    Panel7: TPanel;
    btTestePeso: TButton;
    edTestePeso: TEdit;
    cbQtdBalanca: TComboBox;
    cbLayoutTelaBalanca: TComboBox;
    btConfig: TSpeedButton;
    brSalvar: TButton;
    btTestarValorUnitario: TButton;
    edValorUnitarioTeste: TEdit;
    lbValorUnitarioTeste: TLabel;
    edCompletarDig: TEdit;
    edQtdDigitos: TEdit;
    lbCompletarDig: TLabel;
    lbQtdDigitos: TLabel;
    edComandoFinal: TEdit;
    edComandoInicial: TEdit;
    lbComandoFinal: TLabel;
    lbComandoInicial: TLabel;
    ACBrBAL: TACBrBAL;
    procedure FormShow(Sender: TObject);
    procedure btAnteriorClick(Sender: TObject);
    procedure btProxClick(Sender: TObject);
    procedure btConfigClick(Sender: TObject);
    procedure brSalvarClick(Sender: TObject);
    procedure rgUsaBalancaClick(Sender: TObject);
    procedure cbBalancaChange(Sender: TObject);
    procedure btTestarValorUnitarioClick(Sender: TObject);
  private
    { Private declarations }
    ultBtnGrup, ultBtnProd, ultBtnGrup_Caption, ultBtnGrupEve: String;

    iQtdMesclar, iMesa, sNum, seqItemProdCombo, auxIDCombo, pagGrup, pagProd, TimeOut,
    ultPagGrup, ultPagProd, limitGrup, limitProd, nColunasProd, auxQtdMesc, skip: integer;
  public
    { Public declarations }

    bt_Prod_DivVert  : Integer;
    bt_Prod_DivHorz  : Integer;
    bt_Prod_Heigth   : Integer;
    bt_Prod_Width    : Integer;
    bt_Prod_FontName,sCodprod : String;
    bt_Prod_FontSize : Integer;

    bt_Prod_MaxCaracteres : Integer;
    bt_Prod_InfoValor : Boolean;

    procedure CriaBotoesProdutos(sTipo : String);
    procedure ConfigComponenteBalanca;
    procedure ClickBtnProduto(Sender: TObject);
  end;

var
  fSelecionaProd: TfSelecionaProd;

const
    corBtnGrup        = clWindow;
    corBtnGrupClick   = $0000AA55;
    corBtnProd        = $00BCE3D6;
    corBtnProdClick   = $0000AA55;

implementation

{$R *.dfm}

uses uFuncoes, uModulo, uPrinc;

procedure TFSelecionaProd.CriaBotoesProdutos(sTipo : String);
var
     botao, botao2: TButton ;
     c, l: Integer; //coluna e linha
     x: Integer;
     iLeft, iTop: Integer; //Define a posição e distancia entre os botoes
begin
     limitGrup := 21;

     //Limpa os componentes do pnlProdutos
     while pnlProdutos.ComponentCount > 0 do
          pnlProdutos.Components[pnlProdutos.ComponentCount -1].Destroy;

     sqlcon.Close;
     sqlcon.SQL.Text := 'select '+
                        ' first ' + IntToStr(limitGrup) +
                        ' skip ' + IntToStr(skip) +
                        ' tbprod.codigo, tbprod.descricao, '+
                        ' count(tbprod.codigo) as qtd, ' +
                        ' tbprod.PVendaA ' +
                        ' from tbprod ' +
                        ' left join tbunmed on tbunmed.codigo = tbprod.unmed ' +
                        ' inner join tbgrupo on tbgrupo.codigo = tbprod.grupo ' +
                        ' and tbprod.disponivel = ' +  QuotedStr('S') +
                        ' and tbprod.pvendaa > 0 ' +
                        sTipo;

     sqlcon.SQL.Text := sqlcon.SQL.Text + ' group by tbprod.codigo, tbprod.descricao, '+
                                            'tbprod.PVendaA';

     sqlcon.SQL.Text := sqlcon.SQL.Text + ' order by tbprod.descricao';

     sqlcon.Open;

     ultPagGrup := sqlcon.RecordCount div limitGrup;

     btAnterior.Enabled := skip > 0;
     btProx.Enabled     := skip < ultPagGrup;

     nColunasProd := pnlProdutos.Width div bt_Prod_DivHorz;

     iLeft := bt_Prod_DivHorz - bt_Prod_Width;
     iTop  := bt_Prod_DivVert - bt_Prod_Heigth;

     c := 0;
     l := iTop;

     while sqlcon.Eof = False do
     begin
          inc(c);

          botao := TButton.Create(pnlProdutos);

          botao.Name := 'btProd' + sqlcon.FieldByName('codigo').AsString;

          botao.OnClick := ClickBtnProduto;

          botao.Caption := sqlcon.FieldByName('descricao').AsString;

          //Informa o valor do produto
          if bt_Prod_InfoValor then
               botao.Caption := botao.Caption + #13 +
                    FormatCurr('#,###,##0.00',sqlcon.FieldByName('pvendaa').AsFloat);

          botao.WordWrap := True; //Quebra de linha

          //deixa o botão dentro do pnlProdutos
          botao.Parent := pnlProdutos;

          //atribui o tamanho
          botao.Height := bt_Prod_Heigth;
          botao.Width  := bt_Prod_Width;

          botao.Tag        := 0;
          botao.Font.Color := clWindowText;


          botao.Font.Name := bt_Prod_FontName;
          botao.Font.Size := bt_Prod_FontSize;
          botao.Font.Style := [fsBold];

          //posiciona o botao dentro do pnlProdutos
          if c > 1 then
          begin
               if c > nColunasProd then
               begin
                    c := 1;
                    l := l + iTop + botao.Height;
                    botao.Left := iLeft;
               end
               else
               begin
                    x := botao2.Left + botao2.Width + iLeft;
                    botao.Left := x;
               end;
          end
          else
          begin
               x := iLeft;
               botao.Left := x;
          end;
          botao.Top := l;

          sqlcon.Next;
          botao2 := botao;

          Self.Refresh;
     end;
end;

procedure TFSelecionaProd.ConfigComponenteBalanca;
begin
     if cbBalanca.ItemIndex = 0 then
     begin
          try
               ACBrBAL.Modelo           := TACBrBALModelo(cbModelo1.ItemIndex);
               ACBrBAL.Device.Porta     := cbPortaSerial1.Text;
               ACBrBAL.Device.Baud      := StrToInt(cbBaudRate1.Text);
               ACBrBAL.Device.Data      := StrToInt(cbDataBits1.Text);
               ACBrBAL.Device.Parity    := TACBrSerialParity(cbParity1.ItemIndex);
               ACBrBAL.Device.Stop      := TACBrSerialStop(cbStopBits1.ItemIndex);
               ACBrBAL.Device.HandShake := TACBrHandShake(cbHandShaking1.ItemIndex);
               try
                    TimeOut := StrToInt(edTimeOut1.Text);
               except
                    TimeOut := 2000;
               end;
          except
               Application.MessageBox(PChar(
                    'Verifique as configurações da Balanca1 nos parâmetros.'),
                    'Erro ao configurar balança.',MB_ICONERROR);
               Exit;
          end;
     end
     else if cbBalanca.ItemIndex = 1 then
     begin
          try
               ACBrBAL.Modelo           := TACBrBALModelo(cbModelo2.ItemIndex);
               ACBrBAL.Device.Porta     := cbPortaSerial2.Text;
               ACBrBAL.Device.Baud      := StrToInt(cbBaudRate2.Text);
               ACBrBAL.Device.Data      := StrToInt(cbDataBits2.Text);
               ACBrBAL.Device.Parity    := TACBrSerialParity(cbParity2.ItemIndex);
               ACBrBAL.Device.Stop      := TACBrSerialStop(cbStopBits2.ItemIndex);
               ACBrBAL.Device.HandShake := TACBrHandShake(cbHandShaking2.ItemIndex);
               try
                    TimeOut := StrToInt(edTimeOut2.Text);
               except
                    TimeOut := 2000;
               end;
          except
               Application.MessageBox(PChar(
                    'Verifique as configurações da Balanca2 nos parâmetros.'),
                    'Erro ao configurar balança.',MB_ICONERROR);
               Exit;
          end;
     end
     else if cbBalanca.ItemIndex = 2 then
     begin
          try
               ACBrBAL.Modelo           := TACBrBALModelo(cbModelo3.ItemIndex);
               ACBrBAL.Device.Porta     := cbPortaSerial3.Text;
               ACBrBAL.Device.Baud      := StrToInt(cbBaudRate3.Text);
               ACBrBAL.Device.Data      := StrToInt(cbDataBits3.Text);
               ACBrBAL.Device.Parity    := TACBrSerialParity(cbParity3.ItemIndex);
               ACBrBAL.Device.Stop      := TACBrSerialStop(cbStopBits3.ItemIndex);
               ACBrBAL.Device.HandShake := TACBrHandShake(cbHandShaking3.ItemIndex);
               try
                    TimeOut := StrToInt(edTimeOut3.Text);
               except
                    TimeOut := 2000;
               end;
          except
               Application.MessageBox(PChar(
                    'Verifique as configurações da Balanca3 nos parâmetros.'),
                    'Erro ao configurar balança.',MB_ICONERROR);
               Exit;
          end;
     end;
end;

procedure TfSelecionaProd.brSalvarClick(Sender: TObject);
begin
    pnlConfig.Width := 39;
    pnlConfig.Color := $0010B0FE;
end;

procedure TfSelecionaProd.btAnteriorClick(Sender: TObject);
begin
    skip := skip - 21;
end;

procedure TfSelecionaProd.btConfigClick(Sender: TObject);
begin
     pnlConfig.Width := 224;
     pnlConfig.Color := $00F0F0F0;
end;

procedure TfSelecionaProd.btProxClick(Sender: TObject);
begin
      skip := skip + 21;
end;

procedure TfSelecionaProd.btTestarValorUnitarioClick(Sender: TObject);
var
     iComandoInicial, iComandoFinal, iQtdDigitos, x : Integer;
     sCompletaDig, sFormataDigito, sValorEnviar, sComando : String;
     cValor : Currency;
begin
     iComandoInicial := StrToInt(edComandoInicial.Text);
     iComandoFinal   := StrToInt(edComandoFinal.Text);

     iQtdDigitos  := StrToInt(edQtdDigitos.Text);
     sCompletaDig := edCompletarDig.Text;
     if Trim(sCompletaDig) = '' then
          sCompletaDig := ' ';
     for x := 1 to iQtdDigitos do
          sFormataDigito := sFormataDigito + sCompletaDig;

     sValorEnviar := edValorUnitarioTeste.Text;
     cValor       := StrToCurr(AnsiReplaceStr(sValorEnviar,'.',''));
     sValorEnviar := FormatCurr('#####0.00',cValor);
     sValorEnviar := AnsiReplaceStr(AnsiReplaceStr(sValorEnviar,',',''),'.','');
     sValorEnviar := RightStr(sFormataDigito + Trim(sValorEnviar), iQtdDigitos);

     sComando := char(iComandoInicial) + sValorEnviar + char(iComandoFinal);

     if ACBrBAL.Ativo then
          ACBrBAL.Desativar;

     ConfigComponenteBalanca;

     ACBrBAL.Ativar;

     ACBrBAL.Device.Limpar;
     ACBrBAL.Device.EnviaString(sComando);

     ACBrBAL.Desativar;
end;

procedure TfSelecionaProd.cbBalancaChange(Sender: TObject);
begin
     cbModelo1.Visible        := cbBalanca.ItemIndex = 0;
     cbPortaSerial1.Visible   := cbBalanca.ItemIndex = 0;
     cbBaudRate1.Visible      := cbBalanca.ItemIndex = 0;
     cbDataBits1.Visible      := cbBalanca.ItemIndex = 0;
     cbParity1.Visible        := cbBalanca.ItemIndex = 0;
     cbStopBits1.Visible      := cbBalanca.ItemIndex = 0;
     cbHandShaking1.Visible   := cbBalanca.ItemIndex = 0;
     edTimeOut1.Visible       := cbBalanca.ItemIndex = 0;

     cbModelo2.Visible        := cbBalanca.ItemIndex = 1;
     cbPortaSerial2.Visible   := cbBalanca.ItemIndex = 1;
     cbBaudRate2.Visible      := cbBalanca.ItemIndex = 1;
     cbDataBits2.Visible      := cbBalanca.ItemIndex = 1;
     cbParity2.Visible        := cbBalanca.ItemIndex = 1;
     cbStopBits2.Visible      := cbBalanca.ItemIndex = 1;
     cbHandShaking2.Visible   := cbBalanca.ItemIndex = 1;
     edTimeOut2.Visible       := cbBalanca.ItemIndex = 1;

     cbModelo3.Visible        := cbBalanca.ItemIndex = 2;
     cbPortaSerial3.Visible   := cbBalanca.ItemIndex = 2;
     cbBaudRate3.Visible      := cbBalanca.ItemIndex = 2;
     cbDataBits3.Visible      := cbBalanca.ItemIndex = 2;
     cbParity3.Visible        := cbBalanca.ItemIndex = 2;
     cbStopBits3.Visible      := cbBalanca.ItemIndex = 2;
     cbHandShaking3.Visible   := cbBalanca.ItemIndex = 2;
     edTimeOut3.Visible       := cbBalanca.ItemIndex = 2;
end;

procedure TfSelecionaProd.ClickBtnProduto(Sender: TObject);
var sql : string;
begin
     if pnlProdutos.Tag = 1 then
          Exit;

     ultBtnProd := TButton(Sender).Name;

     if ultBtnProd <> '' then
     begin
         { try (pnlProdutos.FindComponent(ultBtnProd) as TButton).Color      := corBtnProd;
          except; end;
          }
          try (pnlProdutos.FindComponent(ultBtnProd) as TButton).Font.Color := clWindowText;
          except; end;
     end;

     ultBtnProd := TButton(Sender).Name;

     sql := 'select tbprod.descricao, tbprod.codigo, '+
            ' tbunmed.descricao as unmed,'+
            ' tbprod.PVendaA' +
            ' from tbprod'+
            ' left join tbunmed on tbprod.unmed = tbunmed.codigo';

     sql := sql + ' where tbprod.codigo = ' + QuotedStr(AnsiReplaceStr(ultBtnProd,'btProd',''));
     sql := sql + ' and tbunmed.descricao = ''KG''';

     sqlaux.Close;
     sqlaux.SQL.Text := sql;
     sqlaux.Open;

     dm.sCodProd := AnsiReplaceStr(ultBtnProd,'btProd','');

     try
          Application.CreateForm(TfPrinc, fPrinc);
          Fprinc.ShowModal;
     finally
          FreeAndNil(fprinc);
     end;

     //showMessage('honda civic');
end;

procedure TfSelecionaProd.FormShow(Sender: TObject);
begin
    bt_Prod_DivVert  := 127;
    bt_Prod_DivHorz  := 105;
    bt_Prod_Heigth   := 120;
    bt_Prod_Width    := 100;

    bt_Prod_FontName := 'Arial';
    bt_Prod_FontSize := 10;

    bt_Prod_MaxCaracteres := 0;
    bt_Prod_InfoValor     := False;

    skip := 0;

    if Assigned(fprinc) then
        CriaBotoesProdutos('and tbgrupo.descricao = '+ QuotedStr('BEBIDAS'))
    else
        CriaBotoesProdutos('and tbunmed.descricao = '+ QuotedStr('KG'));
end;

procedure TfSelecionaProd.rgUsaBalancaClick(Sender: TObject);
begin
     lbQtdBalanca.Enabled   := rgUsaBalanca.ItemIndex = 0;
     cbQtdBalanca.Enabled   := rgUsaBalanca.ItemIndex = 0;

     cbLayoutTelaBalanca.Enabled := (rgUsaBalanca.ItemIndex = 0) and
                                    (cbQtdBalanca.ItemIndex = 0);

     lbBalanca.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbBalanca.Enabled      := rgUsaBalanca.ItemIndex = 0;

     lbModelo.Enabled       := rgUsaBalanca.ItemIndex = 0;
     lbPortaSerial.Enabled  := rgUsaBalanca.ItemIndex = 0;
     lbBaudRate.Enabled     := rgUsaBalanca.ItemIndex = 0;
     lbDataBits.Enabled     := rgUsaBalanca.ItemIndex = 0;
     lbParity.Enabled       := rgUsaBalanca.ItemIndex = 0;
     lbStopBits.Enabled     := rgUsaBalanca.ItemIndex = 0;
     lbHandshaking.Enabled  := rgUsaBalanca.ItemIndex = 0;
     lbTimeOut.Enabled      := rgUsaBalanca.ItemIndex = 0;

     cbModelo1.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbPortaSerial1.Enabled := rgUsaBalanca.ItemIndex = 0;
     cbBaudRate1.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbDataBits1.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbParity1.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbStopBits1.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbHandShaking1.Enabled := rgUsaBalanca.ItemIndex = 0;
     edTimeOut1.Enabled     := rgUsaBalanca.ItemIndex = 0;

     cbModelo2.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbPortaSerial2.Enabled := rgUsaBalanca.ItemIndex = 0;
     cbBaudRate2.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbDataBits2.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbParity2.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbStopBits2.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbHandShaking2.Enabled := rgUsaBalanca.ItemIndex = 0;
     edTimeOut2.Enabled     := rgUsaBalanca.ItemIndex = 0;

     cbModelo3.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbPortaSerial3.Enabled := rgUsaBalanca.ItemIndex = 0;
     cbBaudRate3.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbDataBits3.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbParity3.Enabled      := rgUsaBalanca.ItemIndex = 0;
     cbStopBits3.Enabled    := rgUsaBalanca.ItemIndex = 0;
     cbHandShaking3.Enabled := rgUsaBalanca.ItemIndex = 0;
     edTimeOut3.Enabled     := rgUsaBalanca.ItemIndex = 0;

     btTestePeso.Enabled    := rgUsaBalanca.ItemIndex = 0;
     edTestePeso.Enabled    := rgUsaBalanca.ItemIndex = 0;
end;

end.

