unit uPrinc;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.StrUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Imaging.jpeg, Vcl.ExtCtrls,
  ACBrBase, ACBrBAL, Vcl.StdCtrls, Data.DB;

type
  TfPrinc = class(TForm)
    pnlTitulo: TPanel;
    Image1: TImage;
    pnlPeso: TPanel;
    FACBrBAL: TACBrBAL;
    mMensagem: TMemo;
    lbBBifood: TLabel;
    procedure FormDestroy(Sender: TObject);
    procedure FACBrBALLePeso(Peso: Double; Resposta: AnsiString);
    procedure FormShow(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormResize(Sender: TObject);
  private
    { Private declarations }
    function lerBalanca(Peso : Double) : boolean;
  public
    { Public declarations }
    peso1 : double;
  end;

var
  fPrinc: TfPrinc;
  codUsuario: Integer;
  nomUsuario, sUserFunc, codCaixa, datasenha: String;
  sAcessoUsuario: String;
  sAcessoSenha: String;

implementation

{$R *.dfm}

uses uFuncoes, uModulo, Utransacao, uMensagem, upesqcad;

function TfPrinc.lerBalanca(Peso : Double) : boolean;
begin
    if peso1 = peso then
       exit
    else
       peso1 := peso;

    if peso < strToFloat('0,030') then
      exit;

    mMensagem.Lines.Clear;
    mMensagem.Color    := clYellow;
    mMensagem.Lines.Add(' ');
    mMensagem.Lines.Add('Lendo balança...');
    mMensagem.Lines.Add(' ');

    sleep(3000);

    if peso1 <> peso then
    begin
        mMensagem.Lines.Clear;
        mMensagem.Lines.Add(' ');
        mMensagem.Lines.Add('Erro na leitura. ');
        mMensagem.Lines.Add('Retire o prato e coloque na balança');
        mMensagem.Color    := clRed;

        pnlPeso.Caption      := '';
        exit;
    end;

    mMensagem.Lines.Clear;
    mMensagem.Color    := clLime;
    mMensagem.Lines.Add(' ');
    mMensagem.Lines.Add('Balança pronta.');
    mMensagem.Lines.Add('coloque o seu prato!');

    pnlPeso.Caption      := Format('%.3f kg', [Peso]);
end;

procedure TfPrinc.FACBrBALLePeso(Peso: Double; Resposta: AnsiString);
begin
    if peso = strToFloat('0,000') then
    begin
        mMensagem.Lines.Clear;
        mMensagem.Lines.Add(' ');
        mMensagem.Lines.Add('Balança pronta.');
        mMensagem.Lines.Add('Coloque o seu prato!');
        mMensagem.Color    := clLime;

        pnlPeso.Caption      := '';

        exit;
    end;

    lerBalanca(Peso);
end;

procedure TfPrinc.FormCreate(Sender: TObject);
begin
    FAcBrBAL.Ativar;
end;

procedure TfPrinc.FormDestroy(Sender: TObject);
begin
   // Desconecta da balança e libera o objeto
    FAcBrBAL.Desativar;
    FAcBrBAL.Free;
end;

procedure TfPrinc.FormResize(Sender: TObject);
begin
    pnlTitulo.Width := Fprinc.Width;
end;

procedure TfPrinc.FormShow(Sender: TObject);
var sql : string;
begin
  sql := 'select descricao, pvendaa from tbprod';

  dm.cdspesqcad.indexfieldnames := '';
  dm.cdspesqcad.Close;
  dm.cdspesqcad.CommandText := SQL;
  dm.cdspesqcad.Open;

  dm.cdspesqcad.indexfieldnames := 'descricao';

  application.createform(tfpesqcad, FPesqcad);

  FPesqcad.dbgpes.columns.rebuildcolumns;

  if Parametro('TIPO_PESQ_CODPROD') = 'P' then
    FPesqcad.dbgpes.columns[0].fieldname := 'codpesquisa'
  else
    FPesqcad.dbgpes.columns[0].fieldname := 'codigo';

  FPesqcad.dbgpes.columns[0].title.Caption := 'Codigo';
  FPesqcad.dbgpes.columns[0].Width := 80;

  FPesqcad.dbgpes.columns[1].fieldname := 'descricao';
  FPesqcad.dbgpes.columns[1].title.Caption := 'Descrição';
  FPesqcad.dbgpes.columns[1].Width := 400;

  TFloatField(dm.cdspesqcad.FieldByName('PVendaA')).DisplayFormat := '#,###,##0.00';
  FPesqcad.dbgpes.columns[2].fieldname := 'PVendaA';
  FPesqcad.dbgpes.columns[2].title.Caption := 'Preço de Venda';
  FPesqcad.dbgpes.columns[2].Width := 93;


    mMensagem.Lines.Clear;
    mMensagem.Lines.Add(' ');
    mMensagem.Lines.Add('Balança pronta.');
    mMensagem.Lines.Add('Coloque o seu prato!');
    mMensagem.Color    := clLime;

    pnlPeso.Caption    := '';
end;

end.
